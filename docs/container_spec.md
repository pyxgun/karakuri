# Container Specification
Container created via `karakuri` is run based on a single configuration file. This configuration file is called *SpecFile* and is created by `futaba spec` command. *SpecFile* includes layer information, standard filesystem setup, resource setup, port mapping, network, and information abount container entrypoint.  

*SpecFile* can be created via `futaba spec` command, but since the `futaba` is not intended for stand-alone use, it highly recommended to cerate *SpecFile* via `karakuri create` command for actual container operations.  
*SpecFile* created by `karakuri create` command are stored in `/etc/karakuri/futaba/[container_id]/config.json`.

## SpecFile
*SpecFile* created by `futaba spec` command is named `config.json`. The information contained in `config.json` is described below.

### Hostname
| Key | Value |
| --- | ----- |
| hostname | [0-9a-f]{12} |

The `hostname` is specified by a 12-digit string of 0-9,a-f. This string is the last 12 digits extracted from the string randomly generated by UUIDv4. This string is used for the container ID and hostname within the container, and the container to be operated on via `karakuri` command.

### Root
| Key | Value |
| --- | ----- |
| path | [container/layer/path] |

The `path` specified the path that will be the *container layer*. To run container via `karakuri`, the path specified here must contain four directories, `diff`, `merged`, `work`, and `fifo`.

### Image
| Key | Value |
| --- | ----- |
| path | [image/layer/path] |

The `path` specified the path that will be the *Image layer*. The path specified here must contain the basic utilities and binaries (typically an image file obtained from the registry) to be executed in the container.

### Fifo
| Key | Value |
| --- | ----- |
| fifo | [fifo/file/path] |

Specifies the path to create a named pipe to be used duaring the container initialization process. This path must be empty. A named pipe, named `exec.fifo`, is created in the initialization process and is used for communication between a parent and child processes duaring initialization.

### Network
| Key | Value |
| --- | ----- |
| hostdevice | [hostdevice] |
| address | [host_address]/[subnet] |
| gateway | [gateway_address] |
| nameserver | [nameserver_address] |
| port.host | [host_port] |
| port.target | [container_port] |
| port.protocol | [tcp\\|udp] |

The address, gateway, nameserver assigned to the container, and the host device to which it is connected are specified. When access with a container from an external network, specify the port number and protocol to be mapped to `port` section.

### Mount
| Key | Value |
| --- | ----- |
| source | [source_path] |
| destination | [destination_path] |
| type | [mount_type] |
| options | [mount_options] |

The following file systems are specified by default to ensure proper execution of the container.
| Destination | Type | Options |
| ----------- | ---- | ------- |
| /proc | proc | nosuid,noexec,nodev |
| /sys | sysfs | nosuid,noexec,nodev,ro |
| /sys/fs/cgroup | cgroup2 | n/a |
| /dev | tmpfs | nosuid,mode=755,size=65536k |
| /dev/pts | devpts | nosuid,noexec,rw,newinstance,mode=620,gid=5,ptmxmode=0666 |
| /dev/mqueue | mqueue | nosuid,noexec,nodev,rw |
| /dev/shm | tmpfs | nosuid,noexec,nodev,rw,mode=1777,size=65536k |

If the host directory is to be mounted, it is specified in addition to these default file systems.

### Cgroup
| Key | Value |
| --- | ----- |
| path | [/sys/fs/cgroup/[container_id]] |
| cpu.max | [cpu_limit] |
| memory.max | [memory_limit] |

Specifiy the CPU and Memory limits available to the container. Containers created via `karakuri` will have the following limits set by default.

| Target | Limit |
| ------ | ----- |
| CPU | 80% |
| Memory | 1024M |


### Process
| Key | Value |
| --- | ----- |
| args | [command] |
| env | [environmental variables] |
| pid | [container process id] |

When the container is invoked, it sets the environmental variables sepcified in `env` first, and then executes the command specified in `args`.  
If the container is successfully launched, `pid` is set to the process ID of the container's root process (init process).


## Sample SpecFile
```json
{
  "version": "0.1.7",
  "process": {
    "args": [
      "/bin/sh"
    ],
    "env": [
      {
        "key": "PATH",
        "value": "/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
      }
    ],
    "pid": 0
  },
  "cgroup": {
    "path": "/sys/fs/cgroup/3e08daaec9a8",
    "cpu": {
      "max": "80%"
    },
    "memory": {
      "max": "1024M"
    }
  },
  "root": {
    "path": "/etc/karakuri/futaba/3e08daaec9a8"
  },
  "image": {
    "path": "/etc/karakuri/hitoha/images/b0c9d60fc5e3/rootfs"
  },
  "hostname": "3e08daaec9a8",
  "fifo": "/etc/karakuri/futaba/3e08daaec9a8/fifo",
  "mounts": [
    {
      "destination": "/proc",
      "type": "proc",
      "source": "proc",
      "options": [
        "nosuid",
        "noexec",
        "nodev"
      ]
    },
    {
      "destination": "/sys",
      "type": "sysfs",
      "source": "sysfs",
      "options": [
        "nosuid",
        "noexec",
        "nodev",
        "ro"
      ]
    },
    {
      "destination": "/sys/fs/cgroup",
      "type": "cgroup2",
      "source": "cgroup",
      "options": null
    },
    {
      "destination": "/dev",
      "type": "tmpfs",
      "source": "tmpfs",
      "options": [
        "nosuid",
        "mode=755",
        "size=65536k"
      ]
    },
    {
      "destination": "/dev/pts",
      "type": "devpts",
      "source": "devpts",
      "options": [
        "rw",
        "nosuid",
        "noexec",
        "newinstance",
        "mode=620",
        "gid=5",
        "ptmxmode=0666"
      ]
    },
    {
      "destination": "/dev/mqueue",
      "type": "mqueue",
      "source": "mqueue",
      "options": [
        "rw",
        "nosuid",
        "nodev",
        "noexec"
      ]
    },
    {
      "destination": "/dev/shm",
      "type": "tmpfs",
      "source": "shm",
      "options": [
        "rw",
        "nosuid",
        "nodev",
        "noexec",
        "mode=1777",
        "size=65536k"
      ]
    },
    {
      "destination": "/home",
      "type": "",
      "source": "/home/user",
      "options": [
        "bind"
      ]
    },
    {
      "destination": "/data",
      "type": "",
      "source": "/mnt/data",
      "options": [
        "bind"
      ]
    }
  ],
  "network": {
    "hostdevice": "karakuri2",
    "address": "10.157.2.2/24",
    "gateway": "10.157.2.1",
    "nameserver": "8.8.8.8",
    "port": [
      {
        "host": 8080,
        "target": 80,
        "protocol": "tcp"
      },
      {
        "host": 2222,
        "target": 22,
        "protocol": "tcp"
      }
    ]
  }
}
```
